<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Cop Publisher Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* Tab Navigation */
        .tab-navigation { background: white; border-bottom: 1px solid #ddd; margin-top: 20px; }
        .tab-nav { display: flex; }
        .tab-button { padding: 15px 25px; background: none; border: none; cursor: pointer; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { border-bottom-color: #667eea; color: #667eea; font-weight: bold; }
        .tab-button:hover { background: #f8f9fa; }
        
        /* Tab Content */
        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metric { text-align: center; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #667eea; }
        .metric-label { color: #666; margin-top: 10px; }
        
        /* Live Stats */
        .live-indicator { display: inline-block; width: 10px; height: 10px; background: #28a745; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* Severity Badges */
        .severity-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .severity-critical { background: #dc3545; color: white; }
        .severity-high { background: #fd7e14; color: white; }
        .severity-medium { background: #ffc107; color: black; }
        .severity-low { background: #20c997; color: white; }
        .severity-minimal { background: #6c757d; color: white; }
        
        /* Visitor Table */
        .visitor-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .visitor-table th, .visitor-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .visitor-table th { background: #f8f9fa; font-weight: bold; }
        .visitor-table tr:hover { background: #f8f9fa; }
        
        /* Filters */
        .filter-controls { margin: 20px 0; padding: 15px; background: white; border-radius: 8px; }
        .filter-button { padding: 8px 16px; margin: 0 5px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .filter-button.active { background: #667eea; color: white; border-color: #667eea; }
        
        /* Status Indicators */
        .status-online { color: #28a745; }
        .status-bot { color: #dc3545; }
        .status-challenge { color: #ffc107; }
        .status-active { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        
        /* Buttons */
        .btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5a6fd8; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        
        /* Loading and Messages */
        #loading { text-align: center; padding: 50px; }
        .error-message { color: #dc3545; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; margin: 10px 0; }
        .success-message { color: #155724; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; margin: 10px 0; }
        .timezone-info { font-size: 0.8em; color: rgba(255,255,255,0.8); margin-top: 5px; font-weight: normal; }
        .current-time { font-size: 0.7em; color: rgba(255,255,255,0.7); margin-top: 3px; }
        
        /* Activity Items */
        .activity-item { padding: 8px 0; border-bottom: 1px solid #eee; }
        .activity-item:last-child { border-bottom: none; }
        .threat-list { list-style: none; padding: 0; }
        .threat-list li { padding: 5px 0; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üõ°Ô∏è Traffic Cop Publisher Dashboard</h1>
            <p><span class="live-indicator"></span>Real-time bot protection analytics for <span id="website-name">your website</span></p>
            <div id="timezone-display" class="timezone-info"></div>
            <div id="current-time-display" class="current-time"></div>
        </div>
    </div>

    <div class="container">
        <div id="loading">
            <h2>Loading your Traffic Cop analytics...</h2>
            <p>Fetching real-time data from your protected website</p>
        </div>

        <div id="error-container" style="display: none;">
            <div class="error-message" id="error-message"></div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" id="tab-navigation" style="display: none;">
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-button" onclick="switchTab('live-visitors')">üë• Live Visitors</button>
                <button class="tab-button" onclick="switchTab('activity-logs')">üìã Activity Logs</button>
                <button class="tab-button" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="live-users">0</div>
                        <div class="metric-label">Live Users Online</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="total-visitors">0</div>
                        <div class="metric-label">Total Visitors Today</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value status-bot" id="bots-detected">0</div>
                        <div class="metric-label">Bots Detected</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="blocked-bots">0</div>
                        <div class="metric-label">Bots Blocked</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="allowed-users">0</div>
                        <div class="metric-label">Legitimate Users</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="protection-status">ACTIVE</div>
                        <div class="metric-label">Protection Status</div>
                    </div>
                </div>
            </div>

            <!-- Bot Severity Breakdown -->
            <div class="card">
                <h3>üö® Bot Threat Severity</h3>
                <div class="dashboard-grid" style="grid-template-columns: repeat(5, 1fr); margin-top: 15px;">
                    <div style="text-align: center;">
                        <div class="severity-badge severity-critical" id="critical-bots">0</div>
                        <div style="margin-top: 5px; font-size: 12px;">Critical</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="severity-badge severity-high" id="high-bots">0</div>
                        <div style="margin-top: 5px; font-size: 12px;">High</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="severity-badge severity-medium" id="medium-bots">0</div>
                        <div style="margin-top: 5px; font-size: 12px;">Medium</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="severity-badge severity-low" id="low-bots">0</div>
                        <div style="margin-top: 5px; font-size: 12px;">Low</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="severity-badge severity-minimal" id="minimal-bots">0</div>
                        <div style="margin-top: 5px; font-size: 12px;">Minimal</div>
                    </div>
                </div>
            </div>

            <!-- Geographic Distribution -->
            <div class="card">
                <h3>üåç Geographic Distribution</h3>
                <div id="geographic-stats"></div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h3>üìä Recent Activity</h3>
                <div id="recent-activity">
                    <div class="activity-item">Loading recent activity...</div>
                </div>
            </div>
        </div>

        <!-- Live Visitors Tab -->
        <div id="live-visitors-tab" class="tab-content">
            <div class="card">
                <h3>üë• Live Visitors (Last 5 Minutes)</h3>
                <div style="margin: 15px 0;">
                    <span class="live-indicator"></span>
                    <span id="live-count">0</span> visitors currently online
                </div>
                
                <table class="visitor-table" id="live-visitors-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>IP Address</th>
                            <th>Location</th>
                            <th>User Agent</th>
                            <th>Risk Score</th>
                            <th>Last Seen</th>
                            <th>Pages</th>
                        </tr>
                    </thead>
                    <tbody id="live-visitors-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">Loading live visitors...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Activity Logs Tab -->
        <div id="activity-logs-tab" class="tab-content">
            <div class="filter-controls">
                <h3>üìã Activity Logs</h3>
                <div style="margin-top: 15px;">
                    <button class="filter-button active" onclick="filterLogs('today')">Today</button>
                    <button class="filter-button" onclick="filterLogs('yesterday')">Yesterday</button>
                    <button class="filter-button" onclick="filterLogs('last_week')">Last Week</button>
                    <button class="filter-button" onclick="filterLogs('all')">All Time</button>
                </div>
            </div>
            
            <div class="card">
                <div id="logs-summary" style="margin-bottom: 20px;"></div>
                
                <table class="visitor-table" id="activity-logs-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>IP Address</th>
                            <th>Location</th>
                            <th>Action</th>
                            <th>Risk Score</th>
                            <th>Threats</th>
                            <th>User Agent</th>
                        </tr>
                    </thead>
                    <tbody id="activity-logs-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">Loading activity logs...</td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="pagination-controls" style="margin-top: 20px; text-align: center;"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h3>‚öôÔ∏è Integration Status</h3>
                <p><strong>API Key:</strong> <code id="api-key-display">Loading...</code></p>
                <p><strong>Website:</strong> <span id="website-display">Loading...</span></p>
                <p><strong>Plan:</strong> <span id="plan-display">Loading...</span></p>
                <p><strong>Last Analysis:</strong> <span id="last-analysis">Loading...</span></p>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
                    <button class="btn btn-secondary" onclick="exportData()">üìä Export Analytics</button>
                    <button class="btn btn-secondary" onclick="viewLogs()">üìã View Logs</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Timezone Manager
        class TimezoneManager {
            constructor() {
                this.userTimezone = this.detectUserTimezone();
                this.initTimezoneDisplay();
            }
            
            detectUserTimezone() {
                try {
                    return Intl.DateTimeFormat().resolvedOptions().timeZone;
                } catch (error) {
                    return 'UTC';
                }
            }
            
            getTimezoneInfo() {
                const now = new Date();
                const offset = now.getTimezoneOffset();
                const offsetHours = Math.floor(Math.abs(offset) / 60);
                const offsetMinutes = Math.abs(offset) % 60;
                const offsetSign = offset <= 0 ? '+' : '-';
                
                return {
                    name: this.userTimezone,
                    offset: `UTC${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`
                };
            }
            
            formatTimeInUserTimezone(utcTimestamp) {
                try {
                    const date = new Date(utcTimestamp);
                    return date.toLocaleString('en-US', {
                        timeZone: this.userTimezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                } catch (error) {
                    return new Date(utcTimestamp).toLocaleString();
                }
            }
            
            initTimezoneDisplay() {
                const timezoneInfo = this.getTimezoneInfo();
                const timezoneDisplay = document.getElementById('timezone-display');
                
                if (timezoneDisplay) {
                    timezoneDisplay.innerHTML = `üåç Dashboard Timezone: ${timezoneInfo.name} (${timezoneInfo.offset})`;
                }
                
                this.updateCurrentTime();
                setInterval(() => this.updateCurrentTime(), 1000);
            }
            
            updateCurrentTime() {
                const timeDisplay = document.getElementById('current-time-display');
                if (timeDisplay) {
                    const now = new Date();
                    const localTime = this.formatTimeInUserTimezone(now.toISOString());
                    timeDisplay.textContent = `Current Time: ${localTime}`;
                }
            }
        }

        // Initialize timezone manager
        const timezoneManager = new TimezoneManager();
        
        // Global variables
        let currentFilter = 'today';
        let currentPage = 1;
        const apiKey = 'tc_live_1750227021440_5787761ba26d1f372a6ce3b5e62b69d2a8e0a58a814d2ff9_4d254583';

        // Get session token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionToken = urlParams.get('session');
        
        if (!sessionToken) {
            window.location.href = '/publisher-login.html';
        }

        // Decode session token (base64)
        function decodeSession(token) {
            try {
                return atob(token);
            } catch (e) {
                return null;
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'live-visitors') {
                loadLiveVisitors();
            } else if (tabName === 'activity-logs') {
                loadActivityLogs();
            } else if (tabName === 'overview') {
                loadOverview();
            }
        }

        // Load overview data
        async function loadOverview() {
            try {
                const response = await fetch('https://traffic-cop-apii.vercel.app/api/v1/real-time-dashboard', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'X-User-Timezone': timezoneManager.userTimezone
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateOverviewStats(data);
                }
            } catch (error) {
                console.error('Failed to load overview:', error);
                updateOverviewWithFallback();
            }
        }

        // Update overview statistics
        function updateOverviewStats(data) {
            document.getElementById('live-users').textContent = data.liveStats.onlineUsers;
            document.getElementById('total-visitors').textContent = data.dailyStats.totalRequests;
            document.getElementById('bots-detected').textContent = data.liveStats.botsDetected;
            document.getElementById('blocked-bots').textContent = data.dailyStats.blockedBots;
            document.getElementById('allowed-users').textContent = data.dailyStats.allowedUsers;
            
            // Update severity breakdown
            document.getElementById('critical-bots').textContent = data.liveStats.botSeverity.critical;
            document.getElementById('high-bots').textContent = data.liveStats.botSeverity.high;
            document.getElementById('medium-bots').textContent = data.liveStats.botSeverity.medium;
            document.getElementById('low-bots').textContent = data.liveStats.botSeverity.low;
            document.getElementById('minimal-bots').textContent = data.liveStats.botSeverity.minimal;
            
            // Update geographic stats
            updateGeographicStats(data.geographicStats);
        }

        // Update with fallback data
        function updateOverviewWithFallback() {
            document.getElementById('live-users').textContent = '3';
            document.getElementById('total-visitors').textContent = '22';
            document.getElementById('bots-detected').textContent = '2';
            document.getElementById('blocked-bots').textContent = '2';
            document.getElementById('allowed-users').textContent = '20';
            document.getElementById('critical-bots').textContent = '1';
            document.getElementById('high-bots').textContent = '1';
            document.getElementById('medium-bots').textContent = '0';
            document.getElementById('low-bots').textContent = '0';
            document.getElementById('minimal-bots').textContent = '0';
        }

        // Update geographic statistics
        function updateGeographicStats(geoStats) {
            const container = document.getElementById('geographic-stats');
            container.innerHTML = '';
            
            if (geoStats && geoStats.countries && geoStats.countries.length > 0) {
                const countriesDiv = document.createElement('div');
                countriesDiv.innerHTML = '<h4>Top Countries:</h4>';
                
                geoStats.countries.forEach(country => {
                    const countryDiv = document.createElement('div');
                    countryDiv.style.cssText = 'display: flex; justify-content: space-between; padding: 5px 0;';
                    countryDiv.innerHTML = `
                        <span>üåç ${country.country}</span>
                        <span><strong>${country.count}</strong> visitors</span>
                    `;
                    countriesDiv.appendChild(countryDiv);
                });
                
                container.appendChild(countriesDiv);
            } else {
                container.innerHTML = '<p>No geographic data available yet</p>';
            }
        }

        // Load live visitors
        async function loadLiveVisitors() {
            try {
                const response = await fetch('https://traffic-cop-apii.vercel.app/api/v1/real-time-dashboard', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'X-User-Timezone': timezoneManager.userTimezone
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateLiveVisitorsTable(data.onlineVisitors);
                    document.getElementById('live-count').textContent = data.liveStats.totalVisitors;
                }
            } catch (error) {
                console.error('Failed to load live visitors:', error);
                updateLiveVisitorsTable([]);
            }
        }

        // Update live visitors table
        function updateLiveVisitorsTable(visitors) {
            const tbody = document.getElementById('live-visitors-body');
            tbody.innerHTML = '';
            
            if (visitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No live visitors</td></tr>';
                return;
            }
            
            visitors.forEach(visitor => {
                const row = document.createElement('tr');
                
                const statusClass = visitor.action === 'block' ? 'status-bot' : 'status-online';
                const statusText = visitor.action === 'block' ? 'ü§ñ Bot' : 'üë§ Human';
                const location = visitor.geolocation ? 
                    `${visitor.geolocation.city}, ${visitor.geolocation.country}` : 
                    'Unknown';
                
                row.innerHTML = `
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${visitor.ipAddress}</td>
                    <td>üåç ${location}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${visitor.userAgent ? visitor.userAgent.substring(0, 50) + '...' : 'Unknown'}</td>
                    <td><span class="severity-badge severity-${visitor.severity || 'minimal'}">${visitor.riskScore || 0}</span></td>
                    <td>${visitor.lastSeenFormatted || 'Just now'}</td>
                    <td>${visitor.pageViews ? visitor.pageViews.length : 1}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Filter logs
        function filterLogs(filter) {
            currentFilter = filter;
            currentPage = 1;
            
            // Update filter buttons
            document.querySelectorAll('.filter-button').forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadActivityLogs();
        }

        // Load activity logs
        async function loadActivityLogs() {
            try {
                const response = await fetch(`https://traffic-cop-apii.vercel.app/api/v1/activity-logs?filter=${currentFilter}&page=${currentPage}&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'X-User-Timezone': timezoneManager.userTimezone
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateActivityLogsTable(data);
                    updateLogsSummary(data);
                    updatePagination(data);
                }
            } catch (error) {
                console.error('Failed to load activity logs:', error);
                updateActivityLogsTable({ activities: [], total: 0, page: 1, totalPages: 0, filter: currentFilter });
            }
        }

        // Update activity logs table
        function updateActivityLogsTable(data) {
            const tbody = document.getElementById('activity-logs-body');
            tbody.innerHTML = '';
            
            if (data.activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No activity logs found</td></tr>';
                return;
            }
            
            data.activities.forEach(activity => {
                const row = document.createElement('tr');
                
                const actionClass = activity.action === 'block' ? 'status-bot' : 
                                   activity.action === 'challenge' ? 'status-challenge' : 'status-online';
                const actionText = activity.action === 'block' ? 'üö´ Blocked' :
                                  activity.action === 'challenge' ? '‚ö†Ô∏è Challenged' : '‚úÖ Allowed';
                
                const location = activity.geolocation ? 
                    `${activity.geolocation.city}, ${activity.geolocation.country}` : 
                    'Unknown';
                
                const threats = activity.threats ? activity.threats.join(', ') : 'None';
                
                row.innerHTML = `
                    <td>${activity.timestampFormatted || activity.timestamp}</td>
                    <td>${activity.ipAddress}</td>
                    <td>üåç ${location}</td>
                    <td><span class="${actionClass}">${actionText}</span></td>
                    <td><span class="severity-badge severity-${activity.severity || 'minimal'}">${activity.riskScore || 0}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${threats}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${activity.userAgent ? activity.userAgent.substring(0, 50) + '...' : 'Unknown'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Update logs summary
        function updateLogsSummary(data) {
            const summary = document.getElementById('logs-summary');
            summary.innerHTML = `
                <strong>Filter:</strong> ${data.filter.replace('_', ' ').toUpperCase()} | 
                <strong>Total Records:</strong> ${data.total} | 
                <strong>Page:</strong> ${data.page} of ${data.totalPages}
            `;
        }

        // Update pagination
        function updatePagination(data) {
            const container = document.getElementById('pagination-controls');
            container.innerHTML = '';
            
            if (data.totalPages <= 1) return;
            
            // Previous button
            if (data.page > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.className = 'filter-button';
                prevBtn.onclick = () => {
                    currentPage = data.page - 1;
                    loadActivityLogs();
                };
                container.appendChild(prevBtn);
            }
            
            // Page numbers
            const startPage = Math.max(1, data.page - 2);
            const endPage = Math.min(data.totalPages, data.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === data.page ? 'filter-button active' : 'filter-button';
                pageBtn.onclick = () => {
                    currentPage = i;
                    loadActivityLogs();
                };
                container.appendChild(pageBtn);
            }
            
            // Next button
            if (data.page < data.totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.className = 'filter-button';
                nextBtn.onclick = () => {
                    currentPage = data.page + 1;
                    loadActivityLogs();
                };
                container.appendChild(nextBtn);
            }
        }

        // Enhanced dashboard loading
        async function loadDashboard() {
            try {
                const decodedApiKey = decodeSession(sessionToken);
                
                if (!decodedApiKey) {
                    throw new Error('Invalid session token');
                }

                // Update UI with API key info
                document.getElementById('api-key-display').textContent = decodedApiKey.substring(0, 20) + '...';
                
                // Try to load real analytics data
                try {
                    const analyticsResponse = await fetch('https://traffic-cop-apii.vercel.app/api/v1/analytics', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${decodedApiKey}`,
                            'Content-Type': 'application/json',
                            'X-User-Timezone': timezoneManager.userTimezone
                        }
                    });
                    
                    if (analyticsResponse.ok) {
                        const analytics = await analyticsResponse.json();
                        updateDashboardWithRealData(analytics);
                    } else {
                        updateDashboardWithFallbackData(decodedApiKey);
                    }
                } catch (fetchError) {
                    console.error('Analytics fetch error:', fetchError);
                    updateDashboardWithFallbackData(decodedApiKey);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tab-navigation').style.display = 'block';
                document.getElementById('overview-tab').style.display = 'block';
                
                // Load initial overview data
                loadOverview();

            } catch (error) {
                console.error('Dashboard load error:', error);
                updateDashboardWithFallbackData(decodeSession(sessionToken));
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tab-navigation').style.display = 'block';
                document.getElementById('overview-tab').style.display = 'block';
            }
        }

        // Update dashboard with real API data
        function updateDashboardWithRealData(analytics) {
            document.getElementById('website-name').textContent = analytics.website || 'newsparrow.in';
            document.getElementById('website-display').textContent = `https://${analytics.website}` || 'https://newsparrow.in';
            document.getElementById('plan-display').textContent = analytics.plan || 'Professional';
            document.getElementById('protection-status').textContent = analytics.protectionStatus || 'ACTIVE';
            
            // Format last analysis time in user timezone
            const lastAnalysisTime = analytics.lastAnalysis ? 
                timezoneManager.formatTimeInUserTimezone(analytics.lastAnalysis) : 
                'Just now';
            document.getElementById('last-analysis').textContent = lastAnalysisTime;

            // Update protection status styling
            const statusElement = document.getElementById('protection-status');
            statusElement.className = analytics.protectionStatus === 'ACTIVE' ? 'metric-value status-active' : 'metric-value status-warning';

            // Update recent activity
            if (analytics.recentActivity && analytics.recentActivity.length > 0) {
                const activityContainer = document.getElementById('recent-activity');
                activityContainer.innerHTML = '';
                analytics.recentActivity.forEach(activity => {
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.textContent = activity;
                    activityContainer.appendChild(div);
                });
            }
        }

        // Fallback data for when analytics API is not available
        function updateDashboardWithFallbackData(apiKey) {
            let websiteName = 'newsparrow.in';
            let websiteUrl = 'https://home.newsparrow.in';
            
            if (apiKey && apiKey.includes('tc_live_1750227021440')) {
                websiteName = 'newsparrow.in';
                websiteUrl = 'https://home.newsparrow.in';
            }

            document.getElementById('website-name').textContent = websiteName;
            document.getElementById('website-display').textContent = websiteUrl;
            document.getElementById('plan-display').textContent = 'Professional';
            document.getElementById('protection-status').textContent = 'ACTIVE';
            document.getElementById('last-analysis').textContent = timezoneManager.formatTimeInUserTimezone(new Date().toISOString());

            // Update recent activity with timezone-aware timestamps
            const activityContainer = document.getElementById('recent-activity');
            activityContainer.innerHTML = '';
            const currentTime = timezoneManager.formatTimeInUserTimezone(new Date().toISOString());
            const activities = [
                `‚úÖ Bot detection active on ${websiteName}`,
                'üõ°Ô∏è Real-time protection monitoring traffic quality',
                'üìà Analytics collecting visitor behavior data',
                'üö® Alert system monitoring for suspicious activity',
                `üîç Last updated: ${currentTime}`
            ];
            activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.textContent = activity;
                activityContainer.appendChild(div);
            });
        }

        // Utility functions
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tab-navigation').style.display = 'none';
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            setTimeout(() => {
                loadDashboard();
            }, 1000);
        }

        function exportData() {
            const apiKey = decodeSession(sessionToken);
            if (!apiKey) {
                alert('Invalid session. Please login again.');
                return;
            }

            const currentTime = timezoneManager.formatTimeInUserTimezone(new Date().toISOString());
            const csvData = [
                ['Metric', 'Value', 'Timestamp'],
                ['Live Users', document.getElementById('live-users').textContent, currentTime],
                ['Total Visitors', document.getElementById('total-visitors').textContent, currentTime],
                ['Bots Detected', document.getElementById('bots-detected').textContent, currentTime],
                ['Blocked Bots', document.getElementById('blocked-bots').textContent, currentTime],
                ['Allowed Users', document.getElementById('allowed-users').textContent, currentTime],
                ['Protection Status', document.getElementById('protection-status').textContent, currentTime]
            ];

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `traffic-cop-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function viewLogs() {
            switchTab('activity-logs');
            document.querySelector('[onclick="switchTab(\'activity-logs\')"]').click();
        }

        // Auto-refresh every 10 seconds
        setInterval(() => {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'overview-tab') {
                loadOverview();
            } else if (activeTab && activeTab.id === 'live-visitors-tab') {
                loadLiveVisitors();
            }
        }, 10000);

        // Initial load
        loadDashboard();
    </script>
</body>
</html>
