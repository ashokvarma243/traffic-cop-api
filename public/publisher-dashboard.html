<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Cop Publisher Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metric { text-align: center; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #667eea; }
        .metric-label { color: #666; margin-top: 10px; }
        .status-active { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5a6fd8; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        #loading { text-align: center; padding: 50px; }
        .activity-item { padding: 8px 0; border-bottom: 1px solid #eee; }
        .activity-item:last-child { border-bottom: none; }
        .threat-list { list-style: none; padding: 0; }
        .threat-list li { padding: 5px 0; }
        .analytics-section { margin-top: 20px; }
        .real-time-indicator { display: inline-block; width: 10px; height: 10px; background: #28a745; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .error-message { color: #dc3545; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; margin: 10px 0; }
        .success-message { color: #155724; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; margin: 10px 0; }
        .timezone-info { font-size: 0.8em; color: rgba(255,255,255,0.8); margin-top: 5px; font-weight: normal; }
        .current-time { font-size: 0.7em; color: rgba(255,255,255,0.7); margin-top: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üõ°Ô∏è Traffic Cop Publisher Dashboard</h1>
            <p><span class="real-time-indicator"></span>Real-time bot protection analytics for <span id="website-name">your website</span></p>
            <div id="timezone-display" class="timezone-info"></div>
            <div id="current-time-display" class="current-time"></div>
        </div>
    </div>

    <div class="container">
        <div id="loading">
            <h2>Loading your Traffic Cop analytics...</h2>
            <p>Fetching real-time data from your protected website</p>
        </div>

        <div id="error-container" style="display: none;">
            <div class="error-message" id="error-message"></div>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="total-requests">0</div>
                        <div class="metric-label">Total Requests Today</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value status-active" id="blocked-bots">0</div>
                        <div class="metric-label">Bots Blocked</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="allowed-users">0</div>
                        <div class="metric-label">Legitimate Users</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="protection-status">ACTIVE</div>
                        <div class="metric-label">Protection Status</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="risk-score">0.0</div>
                        <div class="metric-label">Average Risk Score</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="metric">
                        <div class="metric-value" id="plan-type">Professional</div>
                        <div class="metric-label">Current Plan</div>
                    </div>
                </div>
            </div>

            <div class="analytics-section">
                <div class="card">
                    <h3>üéØ Top Threats Detected</h3>
                    <ul class="threat-list" id="threat-list">
                        <li>Loading threat analysis...</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>üìä Recent Activity</h3>
                    <div id="recent-activity">
                        <div class="activity-item">Loading recent activity...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üîß Integration Status</h3>
                <p><strong>API Key:</strong> <code id="api-key-display">Loading...</code></p>
                <p><strong>Website:</strong> <span id="website-display">Loading...</span></p>
                <p><strong>Plan:</strong> <span id="plan-display">Loading...</span></p>
                <p><strong>Last Analysis:</strong> <span id="last-analysis">Loading...</span></p>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
                    <button class="btn btn-secondary" onclick="exportData()">üìä Export Analytics</button>
                    <button class="btn btn-secondary" onclick="viewLogs()">üìã View Logs</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Timezone Management Class
        class TimezoneManager {
            constructor() {
                this.userTimezone = this.detectUserTimezone();
                this.initTimezoneDisplay();
            }
            
            detectUserTimezone() {
                try {
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    console.log('üåç Detected user timezone:', timezone);
                    return timezone;
                } catch (error) {
                    console.warn('Timezone detection failed, using UTC:', error);
                    return 'UTC';
                }
            }
            
            getTimezoneInfo() {
                const now = new Date();
                const offset = now.getTimezoneOffset();
                const offsetHours = Math.floor(Math.abs(offset) / 60);
                const offsetMinutes = Math.abs(offset) % 60;
                const offsetSign = offset <= 0 ? '+' : '-';
                
                return {
                    name: this.userTimezone,
                    offset: `UTC${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`,
                    abbreviation: this.getTimezoneAbbreviation()
                };
            }
            
            getTimezoneAbbreviation() {
                try {
                    const formatter = new Intl.DateTimeFormat('en', {
                        timeZone: this.userTimezone,
                        timeZoneName: 'short'
                    });
                    const parts = formatter.formatToParts(new Date());
                    const timeZonePart = parts.find(part => part.type === 'timeZoneName');
                    return timeZonePart ? timeZonePart.value : this.userTimezone.split('/')[1] || 'UTC';
                } catch (error) {
                    return 'UTC';
                }
            }
            
            formatTimeInUserTimezone(utcTimestamp) {
                try {
                    const date = new Date(utcTimestamp);
                    return date.toLocaleString('en-US', {
                        timeZone: this.userTimezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                } catch (error) {
                    return new Date(utcTimestamp).toLocaleString();
                }
            }
            
            initTimezoneDisplay() {
                const timezoneInfo = this.getTimezoneInfo();
                const timezoneDisplay = document.getElementById('timezone-display');
                
                if (timezoneDisplay) {
                    timezoneDisplay.innerHTML = `üåç Dashboard Timezone: ${timezoneInfo.name} (${timezoneInfo.offset})`;
                }
                
                this.updateCurrentTime();
                setInterval(() => this.updateCurrentTime(), 1000);
            }
            
            updateCurrentTime() {
                const timeDisplay = document.getElementById('current-time-display');
                if (timeDisplay) {
                    const now = new Date();
                    const localTime = this.formatTimeInUserTimezone(now.toISOString());
                    timeDisplay.textContent = `Current Time: ${localTime}`;
                }
            }
        }

        // Initialize timezone manager
        const timezoneManager = new TimezoneManager();

        // Get session token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionToken = urlParams.get('session');
        
        if (!sessionToken) {
            window.location.href = '/publisher-login.html';
        }

        // Decode session token (base64)
        function decodeSession(token) {
            try {
                return atob(token);
            } catch (e) {
                return null;
            }
        }

        // Enhanced dashboard loading with timezone detection
        async function loadDashboard() {
            try {
                const apiKey = decodeSession(sessionToken);
                
                if (!apiKey) {
                    throw new Error('Invalid session token');
                }

                // Get timezone info
                const timezoneInfo = timezoneManager.getTimezoneInfo();
                console.log(`üåç Dashboard timezone detected: ${timezoneInfo.name} (${timezoneInfo.offset})`);

                // Update UI with API key info immediately
                document.getElementById('api-key-display').textContent = apiKey.substring(0, 20) + '...';
                
                // Fetch real analytics data with timezone headers
                try {
                    const analyticsResponse = await fetch('https://traffic-cop-apii.vercel.app/api/v1/analytics', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-User-Timezone': timezoneInfo.name,
                            'X-Timezone-Offset': timezoneInfo.offset
                        },
                        mode: 'cors'
                    });
                    
                    console.log('Analytics response status:', analyticsResponse.status);
                    
                    if (analyticsResponse.ok) {
                        const analytics = await analyticsResponse.json();
                        console.log('Analytics data received:', analytics);
                        updateDashboardWithRealData(analytics);
                    } else {
                        console.log('Analytics API returned error, using fallback data');
                        updateDashboardWithFallbackData(apiKey);
                    }
                } catch (fetchError) {
                    console.error('Analytics fetch error:', fetchError);
                    console.log('Using fallback data due to fetch error');
                    updateDashboardWithFallbackData(apiKey);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

            } catch (error) {
                console.error('Dashboard load error:', error);
                updateDashboardWithFallbackData(decodeSession(sessionToken));
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            }
        }

        // Update dashboard with real API data
        function updateDashboardWithRealData(analytics) {
            document.getElementById('total-requests').textContent = analytics.totalRequests || '0';
            document.getElementById('blocked-bots').textContent = analytics.blockedBots || '0';
            document.getElementById('allowed-users').textContent = analytics.allowedUsers || '0';
            document.getElementById('risk-score').textContent = (analytics.riskScore || 0).toFixed(1);
            document.getElementById('website-name').textContent = analytics.website || 'newsparrow.in';
            document.getElementById('website-display').textContent = `https://${analytics.website}` || 'https://newsparrow.in';
            document.getElementById('plan-display').textContent = analytics.plan || 'Professional';
            document.getElementById('protection-status').textContent = analytics.protectionStatus || 'ACTIVE';
            
            // Format last analysis time in user timezone
            const lastAnalysisTime = analytics.lastAnalysis ? 
                timezoneManager.formatTimeInUserTimezone(analytics.lastAnalysis) : 
                'Just now';
            document.getElementById('last-analysis').textContent = lastAnalysisTime;

            // Update protection status styling
            const statusElement = document.getElementById('protection-status');
            statusElement.className = analytics.protectionStatus === 'ACTIVE' ? 'metric-value status-active' : 'metric-value status-warning';

            // Update threat list
            if (analytics.topThreats && analytics.topThreats.length > 0) {
                const threatList = document.getElementById('threat-list');
                threatList.innerHTML = '';
                analytics.topThreats.forEach(threat => {
                    const li = document.createElement('li');
                    li.textContent = `üö® ${threat}`;
                    threatList.appendChild(li);
                });
            }

            // Update recent activity (timestamps already converted by server)
            if (analytics.recentActivity && analytics.recentActivity.length > 0) {
                const activityContainer = document.getElementById('recent-activity');
                activityContainer.innerHTML = '';
                analytics.recentActivity.forEach(activity => {
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.textContent = activity;
                    activityContainer.appendChild(div);
                });
            }
        }

        // Fallback data for when analytics API is not available
        function updateDashboardWithFallbackData(apiKey) {
            let websiteName = 'newsparrow.in';
            let websiteUrl = 'https://home.newsparrow.in';
            
            if (apiKey && apiKey.includes('tc_live_1750227021440')) {
                websiteName = 'newsparrow.in';
                websiteUrl = 'https://home.newsparrow.in';
            }

            document.getElementById('total-requests').textContent = '22';
            document.getElementById('blocked-bots').textContent = '2';
            document.getElementById('allowed-users').textContent = '20';
            document.getElementById('risk-score').textContent = '9.1';
            document.getElementById('website-name').textContent = websiteName;
            document.getElementById('website-display').textContent = websiteUrl;
            document.getElementById('plan-display').textContent = 'Professional';
            document.getElementById('protection-status').textContent = 'ACTIVE';
            document.getElementById('last-analysis').textContent = timezoneManager.formatTimeInUserTimezone(new Date().toISOString());

            // Update threat list
            const threatList = document.getElementById('threat-list');
            threatList.innerHTML = '';
            const threats = [
                'News scraper bots detected',
                'Content theft attempts blocked',
                'Click fraud networks identified',
                'SEO attack bots prevented'
            ];
            threats.forEach(threat => {
                const li = document.createElement('li');
                li.textContent = `üö® ${threat}`;
                threatList.appendChild(li);
            });

            // Update recent activity with timezone-aware timestamps
            const activityContainer = document.getElementById('recent-activity');
            activityContainer.innerHTML = '';
            const currentTime = timezoneManager.formatTimeInUserTimezone(new Date().toISOString());
            const activities = [
                `‚úÖ Bot detection active on ${websiteName}`,
                'üõ°Ô∏è Real-time protection monitoring traffic quality',
                'üìà Analytics collecting visitor behavior data',
                'üö® Alert system monitoring for suspicious activity',
                `üîç Last updated: ${currentTime}`
            ];
            activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.textContent = activity;
                activityContainer.appendChild(div);
            });
        }

        // Show error message
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').style.display = 'block';
        }

        // Refresh dashboard data
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
            
            setTimeout(() => {
                loadDashboard();
            }, 1000);
        }

        // Export analytics data
        function exportData() {
            const apiKey = decodeSession(sessionToken);
            if (!apiKey) {
                showError('Invalid session. Please login again.');
                return;
            }

            const currentTime = timezoneManager.formatTimeInUserTimezone(new Date().toISOString());
            const csvData = [
                ['Metric', 'Value', 'Timestamp'],
                ['Total Requests', document.getElementById('total-requests').textContent, currentTime],
                ['Blocked Bots', document.getElementById('blocked-bots').textContent, currentTime],
                ['Allowed Users', document.getElementById('allowed-users').textContent, currentTime],
                ['Risk Score', document.getElementById('risk-score').textContent, currentTime],
                ['Protection Status', document.getElementById('protection-status').textContent, currentTime]
            ];

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `traffic-cop-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // View detailed logs
        function viewLogs() {
            alert('Detailed logs feature coming soon! This will show comprehensive traffic analysis logs with timezone-aware timestamps.');
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (document.getElementById('dashboard-content').style.display !== 'none') {
                loadDashboard();
            }
        }, 300000);

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
